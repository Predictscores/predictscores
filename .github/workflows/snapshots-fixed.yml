name: Snapshots (AM/PM/LATE)

on:
  schedule:
    # SRB 10:00 -> 08:00 UTC
    - cron: '0 8 * * *'
    # SRB 15:00 -> 13:00 UTC
    - cron: '0 13 * * *'
    # SRB 00:00 -> 22:00 UTC (prethodni dan)
    - cron: '0 22 * * *'
  workflow_dispatch:
    inputs:
      slot:
        description: 'am | pm | late | auto'
        required: false
        default: 'auto'

# Koristimo apsolutni URL. Ako BASE_URL secret ne postoji, koristimo fallback.
env:
  BASE: ${{ secrets.BASE_URL }}
  FALLBACK_BASE: https://predictscores.vercel.app

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve BASE and SLOT
        id: ctx
        run: |
          set -euo pipefail
          BASE="${BASE:-}"
          if [ -z "$BASE" ]; then BASE="$FALLBACK_BASE"; fi
          echo "base=$BASE" >> $GITHUB_OUTPUT

          INP="${{ github.event.inputs.slot || '' }}"
          SCH="${{ github.event.schedule || '' }}"
          if [ -n "$INP" ] && [ "$INP" != "auto" ]; then
            SLOT="$INP"
          else
            case "$SCH" in
              "0 8 * * *")  SLOT="am"  ;;
              "0 13 * * *") SLOT="pm"  ;;
              "0 22 * * *") SLOT="late";;
              *)            SLOT="am"  ;; # default pri ručnom pokretanju bez izbora
            esac
          fi
          echo "slot=$SLOT" >> $GITHUB_OUTPUT
          echo "Resolved: BASE=$BASE, SLOT=$SLOT"

      - name: Rebuild (${{ steps.ctx.outputs.slot }} slot)
        run: |
          set -euo pipefail
          echo "CALL: ${{ steps.ctx.outputs.base }}/api/cron/rebuild?slot=${{ steps.ctx.outputs.slot }}"
          curl -fsS "${{ steps.ctx.outputs.base }}/api/cron/rebuild?slot=${{ steps.ctx.outputs.slot }}"

      - name: Refresh odds (window)
        run: |
          set -euo pipefail
          curl -fsS "${{ steps.ctx.outputs.base }}/api/cron/refresh-odds"

      - name: Insights build
        run: |
          set -euo pipefail
          # PRAVILAN endpoint (bez /cron)
          curl -fsS "${{ steps.ctx.outputs.base }}/api/insights-build"

      - name: Apply learning (writes :last)
        run: |
          set -euo pipefail
          curl -fsS "${{ steps.ctx.outputs.base }}/api/cron/apply-learning"

      - name: History settle (last 3 days)
        run: |
          set -euo pipefail
          curl -fsS "${{ steps.ctx.outputs.base }}/api/history-check?days=3"
