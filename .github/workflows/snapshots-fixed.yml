name: Snapshots (AM/PM/LATE)

on:
  schedule:
    - cron: '0 8 * * *'   # 10:00 lokalno (CET/CEST)
    - cron: '0 13 * * *'  # 15:00 lokalno
    - cron: '0 22 * * *'  # 00:00 lokalno
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      BASE: https://predictscores.vercel.app
    steps:
      - name: Pick slot (AM/PM/LATE)
        id: pick
        run: |
          S="${{ github.event.schedule || '' }}"
          if   [ "$S" = "0 8 * * *" ];  then SLOT=am;
          elif [ "$S" = "0 13 * * *" ]; then SLOT=pm;
          elif [ "$S" = "0 22 * * *" ]; then SLOT=late;
          else
            H=$(date -u +%H)
            if   [ "$H" -ge 8  ] && [ "$H" -lt 9  ];  then SLOT=am;
            elif [ "$H" -ge 13 ] && [ "$H" -lt 14 ]; then SLOT=pm;
            elif [ "$H" -ge 22 ] && [ "$H" -lt 23 ]; then SLOT=late;
            else SLOT=pm; fi
          fi
          echo "slot=$SLOT" >> $GITHUB_OUTPUT

      - name: Rebuild snapshot for ${{ steps.pick.outputs.slot }}
        run: |
          curl -fsS "$BASE/api/cron/rebuild?slot=${{ steps.pick.outputs.slot }}"

      - name: Warm odds (2x)
        run: |
          curl -fsS "$BASE/api/cron/refresh-odds" || true
          sleep 5
          curl -fsS "$BASE/api/cron/refresh-odds" || true

      - name: Build insights (Za≈°to: forma + H2H)
        run: |
          curl -fsS "$BASE/api/insights-build" || true

      - name: Apply learning to union
        run: |
          curl -fsS "$BASE/api/cron/apply-learning" || true
