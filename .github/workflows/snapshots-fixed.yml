name: Snapshots (AM/PM/LATE)

on:
  schedule:
    - cron: '0 8 * * *'   # 10:00 lokalno (CET/CEST)
    - cron: '0 13 * * *'  # 15:00 lokalno
    - cron: '0 22 * * *'  # 00:00 lokalno
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      BASE: https://predictscores.vercel.app
    steps:
      - name: Pick slot (AM/PM/LATE)
        id: pick
        shell: bash
        run: |
          S="${{ github.event.schedule }}"
          if [ -z "$S" ]; then S="manual"; fi
          if   [ "$S" = "0 8 * * *" ];  then SLOT=am;
          elif [ "$S" = "0 13 * * *" ]; then SLOT=pm;
          elif [ "$S" = "0 22 * * *" ]; then SLOT=late;
          else
            H=$(date -u +%H)
            if   [ "$H" -ge 22 ]; then SLOT=late;
            elif [ "$H" -ge 13 ]; then SLOT=pm;
            else SLOT=am; fi
          fi
          echo "slot=$SLOT" >> "$GITHUB_OUTPUT"

      - name: Rebuild snapshot for slot
        run: |
          curl -fsS "$BASE/api/cron/rebuild?slot=${{ steps.pick.outputs.slot }}"

      - name: Warm odds (2x)
        run: |
          curl -fsS "$BASE/api/cron/refresh-odds" || true
          sleep 5
          curl -fsS "$BASE/api/cron/refresh-odds" || true

      - name: "Build insights (Zasto / forma + H2H)"
        run: |
          curl -fsS "$BASE/api/insights-build" || true

      - name: Apply learning to union
        run: |
          curl -fsS "$BASE/api/cron/apply-learning" || true
