name: Snapshots (AM/PM/LATE)

on:
  schedule:
    # 10:00 Serbia (CEST, UTC+2) => 08:00 UTC
    - cron: "0 8 * * *"
    # 15:00 Serbia => 13:00 UTC
    - cron: "0 13 * * *"
    # 00:00 Serbia => 22:00 UTC (prethodni dan)
    - cron: "0 22 * * *"
  workflow_dispatch:

jobs:
  run-am:
    if: github.event.schedule == '0 8 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Rebuild (AM slot)
        run: curl -s "${{ secrets.BASE_URL }}/api/cron/rebuild?slot=am"
      - name: Refresh odds (window)
        run: curl -s "${{ secrets.BASE_URL }}/api/cron/refresh-odds"
      - name: Insights build
        run: curl -s "${{ secrets.BASE_URL }}/api/insights-build"
      - name: Apply learning (writes :last)
        run: curl -s "${{ secrets.BASE_URL }}/api/cron/apply-learning"

  run-pm:
    if: github.event.schedule == '0 13 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Rebuild (PM slot)
        run: curl -s "${{ secrets.BASE_URL }}/api/cron/rebuild?slot=pm"
      - name: Refresh odds (window)
        run: curl -s "${{ secrets.BASE_URL }}/api/cron/refresh-odds"
      - name: Insights build
        run: curl -s "${{ secrets.BASE_URL }}/api/insights-build"
      - name: Apply learning (writes :last)
        run: curl -s "${{ secrets.BASE_URL }}/api/cron/apply-learning"

  run-late:
    if: github.event.schedule == '0 22 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Rebuild (LATE slot)
        run: curl -s "${{ secrets.BASE_URL }}/api/cron/rebuild?slot=late"
      - name: Refresh odds (window)
        run: curl -s "${{ secrets.BASE_URL }}/api/cron/refresh-odds"
      - name: Insights build
        run: curl -s "${{ secrets.BASE_URL }}/api/insights-build"
      - name: Apply learning (writes :last)
        run: curl -s "${{ secrets.BASE_URL }}/api/cron/apply-learning"
      - name: History settle (after midnight SRB)
        run: curl -s "${{ secrets.BASE_URL }}/api/history-check?days=3"
